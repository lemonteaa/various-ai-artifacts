Not bad, playable after one minor fix: the CONFIG.ENTITIES map, should be TOWNCENTER. The naming here **cannot**
 be arbitrary because it is relied on to map to the constant string (still hardcoded btw) elsewhere in the codebase. So my next ask is, please identify all the places that uses those hardcoded string 'Villager' for example, and replace that string with "supply from the central config", so eg CONFIG.ENTITIES.VILLAGER.type whose value eval to 'Villager'. In general, you may want to also consider how to map backward (so bidirectional). Also there seems to be a regression where pressing '.' no longer select all idle villagers. (with a call to notify("No idle villagers") if all villagers occupied)

After that, I want more refactoring (still on the safe side technically). One thing that I think is easy win as silly as that sounds: rearrange order where the functions are defined (for some of them). As this code is iteratively developed, placement of some function is append at end but logically it should be elsewhere (the building construction related helper functions as it was tricky). I would also appreciate if there is a clear modularized demarcation of the major components of this game. I think the most unclear part is the "core game logic" - the section GAMEPLAY LOGIC. They look like just a small bunch of utility functions when in fact they are closure over the core `state` map. Bundle into a class? Finally for UI and selection, I think it would be better if UI is separated out in its own section - in near future we will launch UI phase 2 dev, and greatly expand what UI there is in the game. Having the JS part of the UI (that is the most traditional webapp like), being in an easily extracted part, will facilitate this effort.

Finally, aside from coding, please help me take a look over the code, and tell me which global vars are subject to lifecycle rules (i.e. you cannot just set its value once and forget). In near future we will expand this game so that we can restart/end game for instance. Many thanks!